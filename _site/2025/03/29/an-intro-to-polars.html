<!DOCTYPE html><html lang="en" ><head><title>Ovidiu Pârvu | An intro to Polars</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:7rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}.post ul,.project ul,.post ol{list-style-position:inside}.post ul li,.project ul li,.post ol li{padding-left:1rem}main{display:flex;flex-wrap:wrap;max-width:70rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}.highlight table td{padding:5px}.highlight table pre{margin:0}.highlight,.highlight .w{color:#24292f}.highlight .k,.highlight .kd,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .kt,.highlight .kv{color:#cf222e}.highlight .gr{color:#f6f8fa}.highlight .gd{color:#82071e;background-color:#ffebe9}.highlight .nb{color:#953800}.highlight .nc{color:#953800}.highlight .no{color:#953800}.highlight .nn{color:#953800}.highlight .sr{color:#116329}.highlight .na{color:#116329}.highlight .nt{color:#116329}.highlight .gi{color:#116329;background-color:#dafbe1}.highlight .ges{font-weight:bold;font-style:italic}.highlight .kc{color:#0550ae}.highlight .l,.highlight .ld,.highlight .m,.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .il,.highlight .mo,.highlight .mx{color:#0550ae}.highlight .sb{color:#0550ae}.highlight .bp{color:#0550ae}.highlight .ne{color:#0550ae}.highlight .nl{color:#0550ae}.highlight .py{color:#0550ae}.highlight .nv,.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#0550ae}.highlight .o,.highlight .ow{color:#0550ae}.highlight .gh{color:#0550ae;font-weight:bold}.highlight .gu{color:#0550ae;font-weight:bold}.highlight .s,.highlight .sa,.highlight .sc,.highlight .dl,.highlight .sd,.highlight .s2,.highlight .se,.highlight .sh,.highlight .sx,.highlight .s1,.highlight .ss{color:#0a3069}.highlight .nd{color:#8250df}.highlight .nf,.highlight .fm{color:#8250df}.highlight .err{color:#f6f8fa;background-color:#82071e}.highlight .c,.highlight .ch,.highlight .cd,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .c1,.highlight .cs{color:#6e7781}.highlight .gl{color:#6e7781}.highlight .gt{color:#6e7781}.highlight .ni{color:#24292f}.highlight .si{color:#24292f}.highlight .ge{color:#24292f;font-style:italic}.highlight .gs{color:#24292f;font-weight:bold}</style><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ovidiu Pârvu | Technical blog" /><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="An intro to Polars" /><meta name="author" content="Ovidiu Pârvu" /><meta property="og:locale" content="en_US" /><meta name="description" content="This introduction to Polars is my attempt to make it easy for future me to recollect what I have learnt during Polars training sessions provided by Quansight." /><meta property="og:description" content="This introduction to Polars is my attempt to make it easy for future me to recollect what I have learnt during Polars training sessions provided by Quansight." /><link rel="canonical" href="http://localhost:4000/2025/03/29/an-intro-to-polars" /><meta property="og:url" content="http://localhost:4000/2025/03/29/an-intro-to-polars" /><meta property="og:site_name" content="Ovidiu Pârvu Technical blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-03-29T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="An intro to Polars" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ovidiu Pârvu"},"dateModified":"2025-03-29T00:00:00+00:00","datePublished":"2025-03-29T00:00:00+00:00","description":"This introduction to Polars is my attempt to make it easy for future me to recollect what I have learnt during Polars training sessions provided by Quansight.","headline":"An intro to Polars","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2025/03/29/an-intro-to-polars"},"url":"http://localhost:4000/2025/03/29/an-intro-to-polars"}</script> <script> MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] } }; </script> <script id="MathJax-script" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/4.0.0/tex-mml-chtml.min.js"> </script></head><body><main role="main"><header role="banner"><nav role="navigation"><ul><li><a href="/" >Blog</a></li><li><a href="/search" >Search</a></li><li><a href="/about" >About</a></li></ul></nav></header><section class="post"><h2>An intro to Polars</h2><p>This introduction to Polars is my attempt to make it easy for future me to recollect what I have learnt during Polars training sessions provided by <a href="https://quansight.com/training">Quansight</a>.</p><ul><li><a href="#set-up-a-virtual-environment">Set up a virtual environment</a></li><li><a href="#create-a-dataframe">Create a DataFrame</a><ul><li><a href="#basic">Basic</a></li><li><a href="#specify-column-types">Specify column types</a></li><li><a href="#reading-from-a-file-eagerly">Reading from a file eagerly</a></li><li><a href="#reading-from-a-file-lazily">Reading from a file lazily</a></li></ul></li><li><a href="#working-with-dataframe-columns">Working with DataFrame columns</a><ul><li><a href="#select-columns">Select columns</a></li><li><a href="#addreplace-columns">Add/replace columns</a></li><li><a href="#drop-columns">Drop columns</a></li></ul></li><li><a href="#working-with-dataframe-rows">Working with DataFrame rows</a><ul><li><a href="#select-rows">Select rows</a></li><li><a href="#select-every-n-rows">Select every N rows</a></li><li><a href="#adding-a-row-index-column-similar-to-what-is-used-for-pandas-dataframes">Adding a row index column similar to what is used for pandas DataFrames</a></li></ul></li><li><a href="#non-primitive-data-type-columns">Non-primitive data type columns</a><ul><li><a href="#lists">Lists</a><ul><li><a href="#creating-lists-from-values">Creating lists from values</a></li><li><a href="#creating-lists-using-values-from-other-columns">Creating lists using values from other columns</a></li><li><a href="#processing-lists-values">Processing lists values</a></li></ul></li><li><a href="#structs">Structs</a><ul><li><a href="#creating-dataframes-with-struct-columns">Creating DataFrames with struct columns</a></li><li><a href="#unnesting-a-struct-column">Unnesting a struct column</a></li><li><a href="#selecting-a-field-of-a-struct-column">Selecting a field of a struct column</a></li><li><a href="#viewing-the-schema-of-a-dataframe-containing-struct-columns">Viewing the schema of a DataFrame containing struct columns</a></li></ul></li><li><a href="#arrays">Arrays</a></li></ul></li><li><a href="#aggregations">Aggregations</a><ul><li><a href="#mean-of-the-values-in-a-column">Mean of the values in a column</a></li><li><a href="#mean-of-the-values-in-a-column-grouped-by-values-in-another-column">Mean of the values in a column grouped by values in another column</a></li><li><a href="#mean-of-the-values-in-a-column-grouped-by-values-in-another-column-and-joined-back-into-the-initial-dataframe">Mean of the values in a column grouped by values in another column and joined back into the initial DataFrame</a></li></ul></li><li><a href="#handling-missinginvalid-values">Handling missing/invalid values</a><ul><li><a href="#null-vs-nan-in-polars">Null vs NaN in Polars</a></li><li><a href="#counting-values-when-some-are-missinginvalid">Counting values when some are missing/invalid</a></li><li><a href="#dropping-missinginvalid-values">Dropping missing/invalid values</a></li></ul></li><li><a href="#working-with-multiple-dataframes">Working with multiple DataFrames</a><ul><li><a href="#joining-dataframes">Joining DataFrames</a></li><li><a href="#concatenating-dataframes-vertically">Concatenating DataFrames (vertically)</a></li></ul></li><li><a href="#categorical-data">Categorical data</a><ul><li><a href="#restricting-values-to-enum-values">Restricting values to Enum values</a></li></ul></li><li><a href="#using-lazyframes-instead-of-eager-dataframes">Using LazyFrames instead of (eager) DataFrames</a><ul><li><a href="#textual-representation-of-query-plan">Textual representation of query plan</a></li><li><a href="#digraph-representation-of-query-plan">Digraph representation of query plan</a></li></ul></li><li><a href="#executing-row-wise-operations">Executing row-wise operations</a></li><li><a href="#streaming">Streaming</a></li><li><a href="#working-with-timeseries">Working with timeseries</a><ul><li><a href="#creating-datetime-series">Creating datetime Series</a></li><li><a href="#filtering-based-on-datetimes">Filtering based on datetimes</a></li><li><a href="#datetime-difference-between-consecutive-rows">Datetime difference between consecutive rows</a></li><li><a href="#handling-time-zones">Handling time zones</a></li><li><a href="#daylight-saving-time-dst">Daylight Saving Time (DST)</a></li><li><a href="#grouping-data-over-time">Grouping data over time</a></li><li><a href="#rolling-computations">Rolling computations</a></li><li><a href="#upsampling">Upsampling</a></li></ul></li><li><a href="#miscellaneous">Miscellaneous</a></li></ul><p>Right, let’s get to it. First set up a virtual environment. Then go through the examples below.</p><h2 id="set-up-a-virtual-environment">Set up a virtual environment</h2><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uv venv <span class="nt">--seed</span><span class="p">;</span>
<span class="nb">source</span> .venv/bin/activate<span class="p">;</span>
python <span class="nt">-m</span> pip <span class="nb">install </span>uv<span class="p">;</span>
python <span class="nt">-m</span> uv pip <span class="nb">install </span>jupyter pandas polars pyarrow<span class="p">;</span>
</code></pre></div></div><h2 id="create-a-dataframe">Create a DataFrame</h2><h3 id="basic">Basic</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">polars</span> <span class="k">as</span> <span class="n">pl</span>

<span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">],</span> <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]})</span>
</code></pre></div></div><h3 id="specify-column-types">Specify column types</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span>
    <span class="p">{</span><span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">],</span> <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]},</span>
    <span class="n">schema_overrides</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">:</span> <span class="n">pl</span><span class="p">.</span><span class="n">String</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="n">pl</span><span class="p">.</span><span class="n">Int16</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div></div><h3 id="reading-from-a-file-eagerly">Reading from a file eagerly</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pl</span><span class="p">.</span><span class="nf">read_parquet</span><span class="p">(</span><span class="sh">'</span><span class="s">dataset.parquet</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div><h3 id="reading-from-a-file-lazily">Reading from a file lazily</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nf">scan_parquet</span><span class="p">(</span><span class="sh">'</span><span class="s">dataset.parquet</span><span class="sh">'</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
</code></pre></div></div><h2 id="working-with-dataframe-columns">Working with DataFrame columns</h2><h3 id="select-columns">Select columns</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">polars.selectors</span> <span class="k">as</span> <span class="n">cs</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">],</span> <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]})</span>
<span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="nf">all</span><span class="p">()</span> <span class="o">-</span> <span class="n">cs</span><span class="p">.</span><span class="nf">numeric</span><span class="p">())</span>
</code></pre></div></div><h3 id="addreplace-columns">Add/replace columns</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">],</span> <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]})</span>
<span class="n">df</span><span class="p">.</span><span class="nf">with_columns</span><span class="p">(</span>
    <span class="n">keyvalue</span><span class="o">=</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">).</span><span class="nf">cast</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">String</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div><h3 id="drop-columns">Drop columns</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">],</span> <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]})</span>
<span class="n">df</span><span class="p">.</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div><h2 id="working-with-dataframe-rows">Working with DataFrame rows</h2><h3 id="select-rows">Select rows</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">],</span> <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]})</span>
<span class="n">df</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div><h3 id="select-every-n-rows">Select every N rows</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">],</span> <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]})</span>
<span class="n">df</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>             <span class="c1"># Gather every 2nd row
</span><span class="n">df</span><span class="p">.</span><span class="nf">gather_every</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Gather every 2nd row
</span></code></pre></div></div><h3 id="adding-a-row-index-column-similar-to-what-is-used-for-pandas-dataframes">Adding a row index column similar to what is used for pandas DataFrames</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">key</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="p">],</span> <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]})</span>
<span class="n">df</span><span class="p">.</span><span class="nf">with_row_index</span><span class="p">()</span>
</code></pre></div></div><h2 id="non-primitive-data-type-columns">Non-primitive data type columns</h2><h3 id="lists">Lists</h3><h4 id="creating-lists-from-values">Creating lists from values</h4><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="sh">'</span><span class="s">z</span><span class="sh">'</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]})</span>
</code></pre></div></div><h4 id="creating-lists-using-values-from-other-columns">Creating lists using values from other columns</h4><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">]})</span>
<span class="n">df</span><span class="p">.</span><span class="nf">with_columns</span><span class="p">(</span><span class="n">x_y</span><span class="o">=</span><span class="n">pl</span><span class="p">.</span><span class="nf">concat_list</span><span class="p">(</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">))</span>
</code></pre></div></div><h4 id="processing-lists-values">Processing lists values</h4><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="sh">'</span><span class="s">z</span><span class="sh">'</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]})</span>
<span class="n">df</span><span class="p">.</span><span class="nf">with_columns</span><span class="p">(</span><span class="n">z_mean</span><span class="o">=</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">z</span><span class="sh">'</span><span class="p">).</span><span class="nb">list</span><span class="p">.</span><span class="nf">mean</span><span class="p">())</span>
</code></pre></div></div><h3 id="structs">Structs</h3><h4 id="creating-dataframes-with-struct-columns">Creating DataFrames with struct columns</h4><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">cars</span><span class="sh">'</span><span class="p">:</span> <span class="p">[{</span><span class="sh">'</span><span class="s">make</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Audi</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2020</span><span class="p">},</span> <span class="p">{</span><span class="sh">'</span><span class="s">make</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Volkswagen</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">year</span><span class="sh">'</span><span class="p">:</span> <span class="mi">2024</span><span class="p">}]})</span>
</code></pre></div></div><h4 id="unnesting-a-struct-column">Unnesting a struct column</h4><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">.</span><span class="nf">unnest</span><span class="p">(</span><span class="sh">'</span><span class="s">cars</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div><h4 id="selecting-a-field-of-a-struct-column">Selecting a field of a struct column</h4><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">cars</span><span class="sh">'</span><span class="p">).</span><span class="n">struct</span><span class="p">.</span><span class="nf">field</span><span class="p">(</span><span class="sh">'</span><span class="s">make</span><span class="sh">'</span><span class="p">))</span>
</code></pre></div></div><h4 id="viewing-the-schema-of-a-dataframe-containing-struct-columns">Viewing the schema of a DataFrame containing struct columns</h4><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">.</span><span class="n">schema</span>
</code></pre></div></div><h3 id="arrays">Arrays</h3><p>pl.Array is used to represent a fixed-size collection of values. Conversely pl.List is used to represent a variable-size collection of values.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="sh">'</span><span class="s">friends</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">[</span><span class="sh">'</span><span class="s">Mark</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Mary</span><span class="sh">'</span><span class="p">],</span>
            <span class="p">[</span><span class="sh">'</span><span class="s">John</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Jane</span><span class="sh">'</span><span class="p">],</span>
        <span class="p">],</span>
    <span class="p">},</span>
    <span class="n">schema</span><span class="o">=</span><span class="p">{</span>
        <span class="sh">'</span><span class="s">friends</span><span class="sh">'</span><span class="p">:</span> <span class="n">pl</span><span class="p">.</span><span class="nc">Array</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">String</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">)</span>
</code></pre></div></div><h2 id="aggregations">Aggregations</h2><h3 id="mean-of-the-values-in-a-column">Mean of the values in a column</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nf">scan_parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">../titanic.parquet</span><span class="sh">"</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="sh">'</span><span class="s">survived</span><span class="sh">'</span><span class="p">).</span><span class="nf">mean</span><span class="p">().</span><span class="nf">collect</span><span class="p">()</span>
</code></pre></div></div><h3 id="mean-of-the-values-in-a-column-grouped-by-values-in-another-column">Mean of the values in a column grouped by values in another column</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nf">scan_parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">../titanic.parquet</span><span class="sh">"</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="nf">group_by</span><span class="p">(</span><span class="sh">'</span><span class="s">class</span><span class="sh">'</span><span class="p">).</span><span class="nf">agg</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">survived</span><span class="sh">'</span><span class="p">).</span><span class="nf">mean</span><span class="p">()).</span><span class="nf">collect</span><span class="p">()</span>
</code></pre></div></div><h3 id="mean-of-the-values-in-a-column-grouped-by-values-in-another-column-and-joined-back-into-the-initial-dataframe">Mean of the values in a column grouped by values in another column and joined back into the initial DataFrame</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nf">scan_parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">../titanic.parquet</span><span class="sh">"</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">class</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">survived</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">class_mean_survival</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">survived</span><span class="sh">'</span><span class="p">).</span><span class="nf">mean</span><span class="p">().</span><span class="nf">over</span><span class="p">(</span><span class="sh">'</span><span class="s">class</span><span class="sh">'</span><span class="p">)</span>
<span class="p">).</span><span class="nf">collect</span><span class="p">()</span>
</code></pre></div></div><h2 id="handling-missinginvalid-values">Handling missing/invalid values</h2><h3 id="null-vs-nan-in-polars">Null vs NaN in Polars</h3><p>In Polars there is:</p><ul><li>null: missing data.</li><li>nan: floating point number, which results from e.g. 0/0.</li></ul><h3 id="counting-values-when-some-are-missinginvalid">Counting values when some are missing/invalid</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nf">scan_parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">../titanic.parquet</span><span class="sh">"</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="nf">group_by</span><span class="p">(</span><span class="sh">'</span><span class="s">deck</span><span class="sh">'</span><span class="p">).</span><span class="nf">len</span><span class="p">().</span><span class="nf">collect</span><span class="p">()</span>
</code></pre></div></div><h3 id="dropping-missinginvalid-values">Dropping missing/invalid values</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nf">scan_parquet</span><span class="p">(</span><span class="sh">"</span><span class="s">../titanic.parquet</span><span class="sh">"</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="nf">drop_nulls</span><span class="p">().</span><span class="nf">collect</span><span class="p">()</span>
<span class="n">df</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">deck</span><span class="sh">'</span><span class="p">).</span><span class="nf">is_not_null</span><span class="p">()).</span><span class="nf">collect</span><span class="p">()</span>
</code></pre></div></div><h2 id="working-with-multiple-dataframes">Working with multiple DataFrames</h2><h3 id="joining-dataframes">Joining DataFrames</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df1</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">9.1</span><span class="p">],</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">9.2</span><span class="p">,</span> <span class="mf">88.2</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]})</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">9.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="sh">'</span><span class="s">z</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">13124.0</span><span class="p">,</span> <span class="mf">559.3</span><span class="p">]})</span>
<span class="n">df1</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div><h3 id="concatenating-dataframes-vertically">Concatenating DataFrames (vertically)</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df1</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">9.1</span><span class="p">],</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">9.2</span><span class="p">,</span> <span class="mf">88.2</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]})</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">9.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="sh">'</span><span class="s">z</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">13124.0</span><span class="p">,</span> <span class="mf">559.3</span><span class="p">]})</span>
<span class="n">pl</span><span class="p">.</span><span class="nf">concat</span><span class="p">([</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">diagonal</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div><h2 id="categorical-data">Categorical data</h2><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Use a StringCache for the code block below in order to map strings to the same uints when
# creating df1, df2 and pl.concat([df1, df2])
#
# Alternatively, use pl.enable_string_cache() to enable the global string cache if you do not
# have a large number of strings.
</span><span class="k">with</span> <span class="n">pl</span><span class="p">.</span><span class="nc">StringCache</span><span class="p">():</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">blue</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">blue</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">green</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">b</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]},</span>
        <span class="n">schema_overrides</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">:</span> <span class="n">pl</span><span class="p">.</span><span class="n">Categorical</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">green</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">green</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">blue</span><span class="sh">"</span><span class="p">],</span> <span class="sh">"</span><span class="s">b</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]},</span>
        <span class="n">schema_overrides</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">:</span> <span class="n">pl</span><span class="p">.</span><span class="n">Categorical</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="n">df1</span><span class="p">.</span><span class="nf">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">).</span><span class="nf">to_physical</span><span class="p">().</span><span class="n">name</span><span class="p">.</span><span class="nf">suffix</span><span class="p">(</span><span class="sh">'</span><span class="s">_physical</span><span class="sh">'</span><span class="p">))</span>
    <span class="n">df2</span><span class="p">.</span><span class="nf">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">).</span><span class="nf">to_physical</span><span class="p">().</span><span class="n">name</span><span class="p">.</span><span class="nf">suffix</span><span class="p">(</span><span class="sh">'</span><span class="s">_physical</span><span class="sh">'</span><span class="p">))</span>
    <span class="n">pl</span><span class="p">.</span><span class="nf">concat</span><span class="p">([</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">])</span>
</code></pre></div></div><h3 id="restricting-values-to-enum-values">Restricting values to Enum values</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">Series</span><span class="p">([</span><span class="sh">"</span><span class="s">flower</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tree</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">flower</span><span class="sh">"</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pl</span><span class="p">.</span><span class="nc">Enum</span><span class="p">([</span><span class="sh">"</span><span class="s">flower</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">tree</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bonsai</span><span class="sh">"</span><span class="p">]))</span>
<span class="n">s</span><span class="p">.</span><span class="n">dtype</span>
</code></pre></div></div><h2 id="using-lazyframes-instead-of-eager-dataframes">Using LazyFrames instead of (eager) DataFrames</h2><ul><li>Using LazyFrames enables lazy evaluation makes it possible for optimizations to be applied automatically instead of requiring hand-rolled optimizations to be used instead.</li><li>If you use expressions the lazy mode should be equivalent to the eager mode (except the need to call <code class="language-plaintext highlighter-rouge">.collect()</code> at the end).</li></ul><h3 id="textual-representation-of-query-plan">Textual representation of query plan</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">polars</span> <span class="k">as</span> <span class="n">pl</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">LazyFrame</span><span class="p">({</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="sh">"</span><span class="s">b</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]})</span>
<span class="nf">print</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="nf">explain</span><span class="p">())</span>
</code></pre></div></div><h3 id="digraph-representation-of-query-plan">Digraph representation of query plan</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">LazyFrame</span><span class="p">({</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="sh">"</span><span class="s">b</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]})</span>
<span class="n">df</span><span class="p">.</span><span class="nf">show_graph</span><span class="p">()</span>
</code></pre></div></div><h2 id="executing-row-wise-operations">Executing row-wise operations</h2><p>In order to execute some row-wise operations when using Polars one might need to use nested data types.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="sh">'</span><span class="s">b</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]})</span>
<span class="n">df</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">cum_sum_horizontal</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">all</span><span class="p">())).</span><span class="nf">unnest</span><span class="p">(</span><span class="sh">'</span><span class="s">cum_sum</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div><h2 id="streaming">Streaming</h2><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">LazyFrame</span><span class="p">({</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="sh">"</span><span class="s">b</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]})</span>
<span class="n">df</span><span class="p">.</span><span class="nf">with_columns</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">a</span><span class="sh">'</span><span class="p">)</span> <span class="o">+</span> <span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">b</span><span class="sh">'</span><span class="p">)).</span><span class="nf">collect</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="sh">'</span><span class="s">streaming</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div><h2 id="working-with-timeseries">Working with timeseries</h2><h3 id="creating-datetime-series">Creating datetime Series</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pl</span><span class="p">.</span><span class="nf">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="nf">date</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="nf">date</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="sh">'</span><span class="s">1d</span><span class="sh">'</span><span class="p">)</span>
<span class="n">pl</span><span class="p">.</span><span class="nc">Series</span><span class="p">([</span><span class="sh">'</span><span class="s">2025-01-01T01:43</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">2025-01-03T18:44</span><span class="sh">'</span><span class="p">]).</span><span class="nb">str</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">()</span>
<span class="n">pl</span><span class="p">.</span><span class="nc">Series</span><span class="p">([</span><span class="sh">"</span><span class="s">2025 January 01 01:43</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">2025 January 03 18:44</span><span class="sh">"</span><span class="p">]).</span><span class="nb">str</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="sh">'</span><span class="s">%Y %B %d %H:%M</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div><h3 id="filtering-based-on-datetimes">Filtering based on datetimes</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span>
  <span class="sh">'</span><span class="s">now</span><span class="sh">'</span><span class="p">:</span> <span class="n">pl</span><span class="p">.</span><span class="nf">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="nf">date</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="nf">date</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="sh">'</span><span class="s">1d</span><span class="sh">'</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="p">})</span>
<span class="n">df</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">now</span><span class="sh">'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pl</span><span class="p">.</span><span class="nf">date</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">df</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">now</span><span class="sh">'</span><span class="p">).</span><span class="n">dt</span><span class="p">.</span><span class="nf">day</span><span class="p">()</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
</code></pre></div></div><h3 id="datetime-difference-between-consecutive-rows">Datetime difference between consecutive rows</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">({</span>
  <span class="sh">'</span><span class="s">now</span><span class="sh">'</span><span class="p">:</span> <span class="n">pl</span><span class="p">.</span><span class="nf">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="nf">date</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="nf">date</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="sh">'</span><span class="s">1d</span><span class="sh">'</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="p">})</span>
<span class="n">df</span><span class="p">[</span><span class="sh">'</span><span class="s">now</span><span class="sh">'</span><span class="p">].</span><span class="nf">diff</span><span class="p">()</span>
</code></pre></div></div><h3 id="handling-time-zones">Handling time zones</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Time stamp and time zone (if set) are stored separately
</span><span class="n">ser</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">Series</span><span class="p">([</span><span class="sh">'</span><span class="s">2025-01-01T01:43</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">2025-01-03T18:44</span><span class="sh">'</span><span class="p">]).</span><span class="nb">str</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">()</span>                           <span class="c1"># time zone unaware
</span><span class="n">ser</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">Series</span><span class="p">([</span><span class="sh">'</span><span class="s">2025-01-01T01:43</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">2025-01-03T18:44</span><span class="sh">'</span><span class="p">]).</span><span class="nb">str</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">time_zone</span><span class="o">=</span><span class="sh">'</span><span class="s">Europe/London</span><span class="sh">'</span><span class="p">)</span>  <span class="c1"># time zone aware
# Change time zone w/o changing underlying timestamp
</span><span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="p">.</span><span class="n">dt</span><span class="p">.</span><span class="nf">convert_time_zone</span><span class="p">(</span><span class="sh">'</span><span class="s">Asia/Kathmandu</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Change timestamp ignoring current time zone
</span><span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="p">.</span><span class="n">dt</span><span class="p">.</span><span class="nf">replace_time_zone</span><span class="p">(</span><span class="sh">'</span><span class="s">Asia/Kathmandu</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Unset time zone
</span><span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="p">.</span><span class="n">dt</span><span class="p">.</span><span class="nf">replace_time_zone</span><span class="p">(</span><span class="n">time_zone</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</code></pre></div></div><h3 id="daylight-saving-time-dst">Daylight Saving Time (DST)</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Convert a Series into a DataFrame
</span><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nf">datetime_range</span><span class="p">(</span>
    <span class="nf">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="nf">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="sh">"</span><span class="s">1h</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">time_zone</span><span class="o">=</span><span class="sh">"</span><span class="s">Europe/London</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">).</span><span class="nf">to_frame</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">with_columns</span><span class="p">(</span>
  <span class="c1"># Determine the DST offset
</span>  <span class="n">dst_offset</span><span class="o">=</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">).</span><span class="n">dt</span><span class="p">.</span><span class="nf">dst_offset</span><span class="p">(),</span>
  <span class="c1"># Add 1d to date ignoring DST
</span>  <span class="n">day_plus_1d</span><span class="o">=</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">).</span><span class="n">dt</span><span class="p">.</span><span class="nf">offset_by</span><span class="p">(</span><span class="sh">'</span><span class="s">1d</span><span class="sh">'</span><span class="p">),</span>
  <span class="c1"># Add 24h (i.e. 1d) to date considering DST
</span>  <span class="n">day_plus_24h</span><span class="o">=</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">).</span><span class="n">dt</span><span class="p">.</span><span class="nf">offset_by</span><span class="p">(</span><span class="sh">'</span><span class="s">24h</span><span class="sh">'</span><span class="p">),</span>
  <span class="c1"># Handle ambiguities due to DST explicitly
</span>  <span class="n">replaced_time_zone</span><span class="o">=</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">).</span><span class="n">dt</span><span class="p">.</span><span class="nf">replace_time_zone</span><span class="p">(</span>
    <span class="sh">'</span><span class="s">Europe/London</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">ambiguous</span><span class="o">=</span><span class="n">pl</span><span class="p">.</span><span class="nc">Series</span><span class="p">([</span><span class="sh">'</span><span class="s">earliest</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">earliest</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">latest</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">latest</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">latest</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">latest</span><span class="sh">'</span><span class="p">]),</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div><h3 id="grouping-data-over-time">Grouping data over time</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nf">scan_csv</span><span class="p">(</span><span class="sh">"</span><span class="s">../assets.csv</span><span class="sh">"</span><span class="p">,</span> <span class="n">try_parse_dates</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="nf">group_by_dynamic</span><span class="p">(</span>
  <span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">,</span>
  <span class="n">every</span><span class="o">=</span><span class="sh">'</span><span class="s">1mo</span><span class="sh">'</span><span class="p">,</span>
  <span class="n">group_by</span><span class="o">=</span><span class="sh">'</span><span class="s">symbol</span><span class="sh">'</span><span class="p">,</span>
<span class="p">).</span><span class="nf">agg</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="sh">'</span><span class="s">price</span><span class="sh">'</span><span class="p">)).</span><span class="nf">collect</span><span class="p">()</span>
</code></pre></div></div><h3 id="rolling-computations">Rolling computations</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Using rolling_mean_by()
</span><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nf">scan_csv</span><span class="p">(</span><span class="sh">"</span><span class="s">../assets.csv</span><span class="sh">"</span><span class="p">,</span> <span class="n">try_parse_dates</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="p">(</span>
  <span class="n">df</span><span class="p">.</span><span class="nf">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">price</span><span class="sh">'</span><span class="p">).</span><span class="nf">rolling_mean_by</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="sh">'</span><span class="s">5d</span><span class="sh">'</span><span class="p">))</span>
  <span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
<span class="p">)</span>
<span class="c1"># Using rolling()
</span><span class="p">(</span>
  <span class="n">df</span>
  <span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">symbol</span><span class="sh">'</span><span class="p">)</span> <span class="o">==</span> <span class="sh">'</span><span class="s">ABBV</span><span class="sh">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">rolling</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="sh">'</span><span class="s">5d</span><span class="sh">'</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">agg</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">price</span><span class="sh">'</span><span class="p">).</span><span class="nf">mean</span><span class="p">().</span><span class="nf">alias</span><span class="p">(</span><span class="sh">'</span><span class="s">rolling_price</span><span class="sh">'</span><span class="p">))</span>
  <span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
<span class="p">)</span>
<span class="c1"># Rolling mean for each group using over()
</span><span class="p">(</span>
  <span class="n">df</span><span class="p">.</span><span class="nf">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">price</span><span class="sh">'</span><span class="p">).</span><span class="nf">rolling_mean_by</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="sh">'</span><span class="s">5d</span><span class="sh">'</span><span class="p">).</span><span class="nf">over</span><span class="p">(</span><span class="sh">'</span><span class="s">symbol</span><span class="sh">'</span><span class="p">))</span>
  <span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
<span class="p">)</span>
<span class="c1"># Exponentially weighted averages
</span><span class="p">(</span>
  <span class="n">df</span><span class="p">.</span><span class="nf">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="sh">'</span><span class="s">price</span><span class="sh">'</span><span class="p">).</span><span class="nf">ewm_mean_by</span><span class="p">(</span><span class="sh">'</span><span class="s">date</span><span class="sh">'</span><span class="p">,</span> <span class="n">half_life</span><span class="o">=</span><span class="sh">'</span><span class="s">10d</span><span class="sh">'</span><span class="p">))</span>
  <span class="p">.</span><span class="nf">collect</span><span class="p">()</span>
<span class="p">)</span>
</code></pre></div></div><h3 id="upsampling">Upsampling</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">:</span> <span class="n">pl</span><span class="p">.</span><span class="nf">date_range</span><span class="p">(</span><span class="nf">date</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nf">date</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="sh">'</span><span class="s">4d</span><span class="sh">'</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="sh">'</span><span class="s">value</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="c1"># Without filling in missing values
</span><span class="n">df</span><span class="p">.</span><span class="nf">upsample</span><span class="p">(</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">,</span> <span class="n">every</span><span class="o">=</span><span class="sh">'</span><span class="s">1d</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># Filling in missing values
</span><span class="n">df</span><span class="p">.</span><span class="nf">upsample</span><span class="p">(</span><span class="sh">'</span><span class="s">ts</span><span class="sh">'</span><span class="p">,</span> <span class="n">every</span><span class="o">=</span><span class="sh">'</span><span class="s">1d</span><span class="sh">'</span><span class="p">).</span><span class="nf">interpolate</span><span class="p">()</span>
</code></pre></div></div><h2 id="miscellaneous">Miscellaneous</h2><ul><li>Data is stored in a columnar (Arrow) format when using Polars.</li><li>In Polars objects are usually immutable.</li><li>In order to improve execution time performance use non-eval approach first, eval second, map_batches third and map_elements fourth (because of jumping btw. Python and a Rust binary)</li><li>Use struct column type if the format/structure of a column is fixed. Otherwise use object type.</li><li>pl.Series()._get_buffers() -&gt; underlying representation.</li><li>.collect([new_]streaming=True, gpu=True) for using streaming and/or GPUs when collecting results from a lazy DataFrame.</li><li>Using sorted data enables Polars to use some optimizations which reduce execution time. Use <code class="language-plaintext highlighter-rouge">set_sorted</code> to tell Polars that data is sorted (Polars won’t check, so use w/ care).</li></ul><span class="meta"><time datetime="2025-03-29T00:00:00+00:00">March 29, 2025</time> &middot; <a href="/tag/polars">polars</a>, <a href="/tag/python">python</a>, <a href="/tag/data">data</a>, <a href="/tag/analysis">analysis</a></span> <!--<span class="meta"><time datetime="2025-03-29T00:00:00+00:00">March 29, 2025</time> &middot; <a class="post" href="/tag/polars">polars</a>, <a class="post" href="/tag/python">python</a>, <a class="post" href="/tag/data">data</a>, <a class="post" href="/tag/analysis">analysis</a></span> --></section></main></body></html>
